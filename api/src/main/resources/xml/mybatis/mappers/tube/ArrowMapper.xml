<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="photon.tube.model.ArrowMapper">

    <resultMap type="arrow" id="arrowResultMap">
        <id property="id" column="id"/>
        <result property="origin" column="origin"/>
        <result property="target" column="target"/>
        <result property="active" column="active"/>
        <result property="type" column="type"/>
    </resultMap>

    <select id="selectOne" resultMap="arrowResultMap">
        SELECT *
        FROM tube.arrow
        WHERE id = #{id}
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tube.arrow (origin, target, type)
        VALUES (#{origin}, #{target}, #{type})
    </insert>

    <select id="selectByOrigin" resultMap="arrowResultMap">
        SELECT *
        FROM tube.arrow
        WHERE origin = #{origin} AND active
    </select>

    <select id="selectActive" resultMap="arrowResultMap">
        SELECT *
        FROM tube.arrow
        WHERE active
    </select>

    <select id="originIdSet" resultType="int">
        SELECT origin
        FROM tube.arrow
    </select>

    <select id="neighborIdSet" resultType="int">
        SELECT target
        FROM tube.arrow
        WHERE origin = #{origin} AND type = #{type} AND active
    </select>

    <delete id="delete">
        DELETE FROM tube.arrow
        WHERE id = #{id}
    </delete>

    <delete id="deleteSimilar">
        DELETE FROM tube.arrow
        WHERE origin = #{origin} AND target = #{target} AND type = #{type}
    </delete>

    <delete id="deleteByNode">
        DELETE FROM tube.arrow
        WHERE origin = #{id} OR target = #{id}
    </delete>

    <update id="deactivateByNode">
        UPDATE tube.arrow
        SET active = FALSE
        WHERE origin = #{id} OR target = #{id}
    </update>

    <update id="reactivateByNode">
        UPDATE tube.arrow, tube.node
        SET tube.arrow.active = TRUE
        WHERE (tube.arrow.origin = #{id} AND tube.arrow.target = tube.node.id AND tube.node.active) OR
              (tube.arrow.target = #{id} AND tube.arrow.origin = tube.node.id AND tube.node.active)
    </update>

</mapper>